name: Docker Build and Push

on:
  push:
    branches:
      - develop

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Dependencies
        run: yarn
    
      - name: Check AWS CLI version
        run: aws --version
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
            aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
            aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS }}
            aws-region: eu-west-1

      - name: Pulumi deploy dev
        if: startsWith(github.ref, 'refs/heads/develop')
        uses: pulumi/actions@v3
        with:
          command: up
          stack-name: mpi/test
          work-dir: apps/infra
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}

      - name: Authenticate with AWS ECR
        run: aws ecr get-login-password --region eu-west-1 | docker login --username AWS --password-stdin 730335240006.dkr.ecr.eu-west-1.amazonaws.com

      - name: Set DATABASE_URL environment variable
        run: echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> $GITHUB_ENV        

      - name: Build Docker image
        run: docker build -t poc . --build-arg DATABASE_URL=${{ env.DATABASE_URL }}

      # - name: Pull existing Docker image
      #   run: docker pull 730335240006.dkr.ecr.eu-west-1.amazonaws.com/poc:latest

      # - name: Delete existing Docker image
      #   run: docker rmi 730335240006.dkr.ecr.eu-west-1.amazonaws.com/poc:latest
      # TODO: https://www.pulumi.com/registry/packages/awsx/api-docs/ecr/repository/#lifecyclepolicy_nodejs

      - name: Tag Docker image
        run: docker tag poc:latest 730335240006.dkr.ecr.eu-west-1.amazonaws.com/poc:latest

      - name: Push Docker image to AWS ECR
        run: docker push 730335240006.dkr.ecr.eu-west-1.amazonaws.com/poc:latest
